# Coloring-Images-Network

Цель:
Обучить сеть раскрашивать изображения.

Это проект создан для решения проблемы раскрашивания изображений.
Эволюция проекта:.
  1) Я научился раскрашивать несколько изображений, сеть была типа fullCNN, просто были свёрточные слои VGG19
  и потом они развертывались и исходному формату, и приводились к размерности (224х224х2), где 2 - это недостающие элементы изображения

  2) Потом я спроектировал сеть для раскрашивания буквально 5 изображений, разного типа, где было 2 сети, первая это автоэнкодер, где в середине к нему присоединялся слой с выхода второй сети, вторая сеть была просто классификатором,
  такая схема научилась, раскрашивать буквально пару изображений, само собой сеть, на новых данных вообще нечего не может сделать.

  3) Финальная. О ней пойдет речь дальше

# Конструкция сети

В разработке сети, я решил воспользоваться нескольким новыми подходами - это Skip Connection и Inception. Раньше, результат классификатора, изменялся в размерность и умножался несколько раз. Классификатор и раскрашивающая модель, это разных модели, где для каждой есть своя метрика и свой loss.
В моменте классификации, у нас сеть развертывается и одна часть идет на классификатор, а другая на в "преобразователь", где мы вектор 512, еще раз пропускаем через полносвязный слой из 512 нейровнов. 
И дальше для каждого уровня транспонированной сети к ней присоединяется, не только параллельный Skip Connection, с начала сити, но и также результат с "преобразователя".

Такая получилась сеть.

<img width="16384" alt="Untitled" src="https://github.com/semenshestakov/Coloring-Images-Network/assets/94396766/74f8bc01-411b-4c55-aeaf-f074cc8c3d31">


ссылка на figma https://www.figma.com/file/qaSDSXUYo8yYm1U1XW7Keh/Untitled?type=whiteboard&node-id=0%3A1&t=PjbdVwTN3DFdnmAi-1

Обучал я в Colab, каждая эпоха длилась примерно до 800 сек. Обучал 33 эпохи, но по-сути после 15, обучение было бессмысленное.
В данной сети, по-хорошему надо уменьшить(подобрать), количество нейронов в слое который разветвляется на классификатор и в "преобразователь". Так же возможно добавить Dropout перед последним слоем классификации.
Так как классификатор заметно переобучался, но я на это не обращал внимание, так как основная цель проекта, была научить раскашивать изображения, а не их классифицировать. Но по скольку дата сет у меня был для размечен как для классификации, я решил реализовать 2 варианта.

# О данных

Я хотел выбрать данные не совсем стандартные, поэтому выбрал дата сет(далее ДС) на Kaggle с бабочками 
https://www.kaggle.com/datasets/gpiosenka/butterfly-images40-species


Вот пример нескольких экземлпров ДС, справа оригинальные данные, слева данные, которые я подаю на вход нейросети(НС).
![output2](https://github.com/semenshestakov/Coloring-Images-Network/assets/94396766/c61b9bac-d60c-40df-99e1-b52c6b6fbbab)


# Как я преоброзовал данные? 
По скольку данные у нас в RGB, я из преобразую в LAB, где вход в НС это L, а требую на выход AB, где L - это диапазон от 0 до 100, а AB диапазон от -1 до 1. Выбор функции активации очевиден - это гиперболический тангенс.

https://avatars.mds.yandex.net/get-images-cbir/371729/s_sBw6Ki4LByJ-eREvIwvA6347/ocr![image](https://github.com/semenshestakov/Coloring-Images-Network/assets/94396766/ebc3acd1-6325-4715-bef5-628c068a07b3)

Данные L -  методом опытных путей, я пришел к выводу, что для RESnet50(выбор для классификации) необходимо данные подавать не в диапазоне от 0 до 1, а что-то по-серьезней - от 0 до 100 - подходит. А для сети для раскрашивания, лучше подходит диапазон от 0 до 1. 
Поэтому на выход НС подаётся изображение L в диапазоне от 0 до 1,а где сеть расходиться в 2 стороны то для RESnet50 данные умножаются на 100. 

# Результаты 
После обучения сети получились такие результаты:
Обучался, я само собой на тренировочной выборке около 12000 элементов, а смотрел на результаты на валидационной выборке. mse все время у то и той выборки был примерно одинаковый. НО после 25 эпохи различие между валидацией и тренировочной выборки были все больше и большое, по итогу обучения (33 эпоха) mse - 0.009..., а val_mse примерно 0.0125 (К сожалению colab ограничивает длину сессии поэтому не получилось сохранить результат, но после обучения сети я понял как можно сохранять результат )

![res 5ep](https://github.com/semenshestakov/Coloring-Images-Network/assets/94396766/efa8a3c0-783b-421a-9927-d73f4c27561e)
![res25ep](https://github.com/semenshestakov/Coloring-Images-Network/assets/94396766/fce19c8a-2a33-40fc-b352-52bd5baa28c1)
![res 33ep](https://github.com/semenshestakov/Coloring-Images-Network/assets/94396766/67d4305b-386a-47c5-a9b9-88c102821e96)

![res 5ep(2)](https://github.com/semenshestakov/Coloring-Images-Network/assets/94396766/da982216-bed9-4217-84aa-14df597eac97)
![res ep25(2)](https://github.com/semenshestakov/Coloring-Images-Network/assets/94396766/adee61a7-1b10-4c62-8a7e-0ba0f6108e8a)
![res 33ep(2)](https://github.com/semenshestakov/Coloring-Images-Network/assets/94396766/29e234a3-dd1c-4c53-b921-2285be85b11d)

![output](https://github.com/semenshestakov/Coloring-Images-Network/assets/94396766/271ea7ce-9795-45ee-afbd-9f86b1b48ca3)


Еще несколько вариантов, как выглядит раскрашивание на данных где не видно оригинал:
![Unknown-16](https://github.com/semenshestakov/Coloring-Images-Network/assets/94396766/8eefb1f4-a417-4fe4-ab73-30d76e86431a)
![Unknown-11](https://github.com/semenshestakov/Coloring-Images-Network/assets/94396766/597d2061-63fd-422a-8458-28a79600fdf0)
![Unknown-18](https://github.com/semenshestakov/Coloring-Images-Network/assets/94396766/ea20f00f-94af-469e-988e-0e2106d8deb0)
![Unknown-17](https://github.com/semenshestakov/Coloring-Images-Network/assets/94396766/a5d35f68-70ed-4396-9f31-f90e58623030)


Гипотеза 1. Можно обратить внимание, что края достаточно четкие, это я думаю, потому что в Inception были использованы свертки 1х1, которые хорошо сохраняют исходные края.
Если посмотреть результаты похожих по структуре сетей, то очень бросается в глаз, что раскрашивание очень размытое, но и обучались такие сети на других данных. 

Гипотеза 2. Сложность данных. По-скольку обычные ДС, которые состоят из разных форм жизни или разных объектов, то в этих данных проще найти различие цветов, а что касаемо бабочек, то форма некоторых из них очень схожи, и разветвление от классификатора и наличие классификатора позволяет, понять какую цветовую палитру использовать при раскрашивании. Это позволяет добиться хорошего результата в выборе цветов нейросети.

